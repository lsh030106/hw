#include <openssl/err.h>
#include <openssl/evp.h>
#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>

void aes128Decrypt(unsigned char *ct);

void aes128Encrypt(unsigned char *pt) {
    int fd, lenght;
    int ctlen, num_byte = 0;

    const EVP_CIPHER *c = EVP_aes_128_ecb();
    EVP_CIPHER_CTX *ctx;
    ctx = EVP_CIPHER_CTX_new();

    if (ctx == 0) {
        //error;
        printf("\n");
    }

    EVP_EncryptInit_ex(ctx, c, NULL, NULL, NULL);
   
    unsigned char key[EVP_CIPHER_CTX_key_length(ctx)]; 

    fd = open("secretkey.key", O_RDONLY);
    if (fd == -1) {
        // error;
        printf("\n");
    }

    lenght = read(fd, key, EVP_CIPHER_CTX_key_length(ctx));
   
    unsigned char ct[strlen((char *)pt + EVP_CIPHER_CTX_block_size(ctx))];
    
    EVP_EncryptInit_ex(ctx, c, NULL, key, NULL);

    EVP_EncryptUpdate(ctx, &ct[ctlen], &num_byte, &pt[ctlen], (int)strlen((char *)pt));

    ctlen += num_byte;
    EVP_EncryptFinal_ex(ctx, &ct[ctlen], &num_byte);
    EVP_CIPHER_CTX_free(ctx);
    
    printf("%s\n", ct);

    aes128Decrypt(ct);
}

void aes128Decrypt(unsigned char *ct) {
    const EVP_CIPHER *c = EVP_aes_128_ecb();
    EVP_CIPHER_CTX *ctx;
    ctx = EVP_CIPHER_CTX_new();

    if (ctx == 0) {
        //error;
        printf("\n");
    }
    
    printf("%d\n", EVP_CIPHER_CTX_block_size(ctx));
    printf("%ld\n", strlen(ct));

    unsigned char pt[strlen(ct) + EVP_CIPHER_CTX_block_size(ctx) + 1];

    int ptlen, num_byte = 0;

    EVP_DecryptUpdate(ctx, &pt[ptlen], &num_byte, &ct[ptlen], strlen(ct));
    
    pt[num_byte] = '\0';

    printf("%s\n", pt);
}

int main(void) {
    char pt[] = "test aes test";
    aes128Encrypt(pt);
    

    return 0;
}

